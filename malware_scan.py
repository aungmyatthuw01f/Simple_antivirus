import argparse
import os
import requests
import hashlib
import json
import time

API_KEY = 'YOUR_VIRUSTOTAL_API_KEY_HERE'

def get_file_report(resource):
    url = 'https://www.virustotal.com/vtapi/v2/file/report'
    params = {'apikey': API_KEY, 'resource': resource}
    response = requests.get(url, params=params)
    try:
        response.raise_for_status()
        if response.text.strip():
            return response.json()
        else:
            print("No response content available. File may not be in VirusTotal database.")
            return None
    except requests.exceptions.HTTPError as e:
        print(f"HTTP error occurred: {e}")
    except requests.exceptions.JSONDecodeError as e:
        print(f"Invalid JSON response: {e}")
    return None

def upload_file(filepath):
    url = 'https://www.virustotal.com/vtapi/v2/file/scan'
    files = {'file': (os.path.basename(filepath), open(filepath, 'rb'))}
    params = {'apikey': API_KEY}
    response = requests.post(url, files=files, params=params)
    try:
        response.raise_for_status()
        upload_response = response.json()
        resource = upload_response['resource']
        print(f"File submitted successfully. Waiting for analysis report for {os.path.basename(filepath)}...")
        return resource
    except requests.exceptions.HTTPError as e:
        print(f"HTTP error during file upload: {e}")
    except requests.exceptions.JSONDecodeError as e:
        print(f"Invalid JSON response during file upload: {e}")
    except Exception as e:
        print(f"Error uploading file: {e}")
    finally:
        if 'files' in locals():
            files['file'][1].close()
    return None

def wait_for_report(resource, filepath):
    print("Checking for analysis result...")
    result = None
    while not result:
        result = get_file_report(resource)
        if result and result.get('response_code') == 1:
            return result
        else:
            print(f"Still waiting for the analysis result for {filepath}...")
            time.sleep(20)
    return None

def scan_file(filepath, detailed):
    file_size = os.path.getsize(filepath)
    if file_size > 5242880:
        print(f"File {filepath} exceeds the 5 MB size limit and will not be uploaded.")
        return

    hasher = hashlib.md5()
    with open(filepath, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hasher.update(chunk)
    file_hash = hasher.hexdigest()
    result = get_file_report(file_hash)

    if not result or result.get('response_code') == 0:
        print(f"Hash not found in VirusTotal. Uploading {filepath} for analysis...")
        resource = upload_file(filepath)
        if resource:
            result = wait_for_report(resource, filepath)

    if result and result.get('response_code') == 1:
        if result.get('positives', 0) > 0:
            print(f"\033[91m\nMalware detected in file: {filepath}\033[0m")
            print(f"Detected by {result['positives']} engines out of {result['total']}.")
            if detailed:
                print(f"Detection Date: {result.get('scan_date')}")
                print("Detailed Malware Information:")
                print(json.dumps(result.get('scans'), indent=4))
        else:
            print(f"No malware detected in file: {filepath}")
    elif not result:
        print(f"Analysis for {filepath} could not be completed or no conclusive results were obtained.")

def scan_folder(folder_path, detailed):
    for root, _, files in os.walk(folder_path):
        for file in files:
            file_path = os.path.join(root, file)
            scan_file(file_path, detailed)

def main():
    parser = argparse.ArgumentParser(description='Scan files and folders for malware using VirusTotal.')
    parser.add_argument('path', type=str, help='Path to the file or folder to scan')
    parser.add_argument('-m', '--detailed', action='store_true', help='Show detailed malware information for detected files')
    args = parser.parse_args()

    if os.path.isfile(args.path):
        scan_file(args.path, args.detailed)
    elif os.path.isdir(args.path):
        scan_folder(args.path, args.detailed)
    else:
        print("The specified path does not exist.")

if __name__ == '__main__':
    main()
